# Monorepo 和 Multirepo 的技术选型

## 什么是 Monorepo

Monorepo 是一种项目代码管理方式，值单个仓库管理多个项目，有助于简化代码共享、版本控制、构建和部署等方面的复杂性，并提供了更好的可重用性和协作性。Monorepo 提倡了更开放、透明、共享的组织文化。

## Monorepo 的演进

- 阶段一：单仓库巨石应用：一个 git 仓库维护着项目代码，随着迭代业务复杂度的提升，项目代码会变得越来越多，越来越复杂，大量代码构建效率也会降低，最终导致了单体巨石应用，这种代码管理方式称之为 Monolith
- 阶段二：多仓库多模块应用：将项目拆解成多个业务模块，并在多个 git 仓库管理，模块解耦，降低了巨石应用的复杂度，每个模块都可以独立编码、测试、发版，代码管理变得简化，构建效率也得以提升，这种代码管理方式称之为 MultiRepo
- 阶段三：单仓库多模块应用：随着业务复杂度的提升，模块仓库越来越多，MultiRepo这种方式虽然从业务上解耦了，但增加了项目工程管理的难度，随着模块仓库达到一定数量级，会有几个问题：跨仓库代码难共享；分散在单仓库的模块依赖管理复杂（底层模块升级后，其他上层依赖需要及时更新，否则有问题）；增加了构建耗时。于是将多个项目集成到一个仓库下，共享工程配置，同时又快捷地共享模块代码，成为趋势，这种代码管理方式称之为 MonoRepo

## Monorepo 的优劣

### 优势

1. 代码的重用将变得非常容易：由于所有的项目代码都集中于一个代码仓库，将很容易抽离出各个项目共用的业务组件或工具，并通过 Typescript，Lerna或其他工具进行代码内引用。
2. 依赖管理将变得非常简单：由于项目之间的引用路径内化在同一个仓库之中，将会很容易追踪当某个项目的代码修改后，会影响到其他哪些项目。通过使用一些工具，将会很容易地做到版本依赖管理和版本号自动升级。
3. 代码重构将变得非常便捷：在 Monorepo 策略的指引下，能够明确知道代码的影响范围，并且可以对被影响的项目进行统一的测试，这将会鼓励你不断优化代码。
4. 倡导了开放、透明、共享的组织文化，有利于开发者成长，代码质量的提升：在 Monorepo 策略下，每个开发者都被鼓励去查看，修改他人的代码（只要有必要），同时，也会激起开发者维护代码，和编写单元测试的责任心（毕竟朋友来访之前，我们从不介意自己的房子究竟有多乱），这将会形成一种良性的技术氛围，从而保障整个组织的代码质量。

### 劣势

1. 项目粒度的权限管理变得非常复杂：无论是 Git 还是其他 VCS 系统，在支持 monorepo 策略中项目粒度的权限管理上都没有令人满意的方案，这意味着 A 部门的 a 项目若是不想被 B 部门的开发者看到就很难了。
2. 学习成本变高：不同于一个项目一个代码仓库这种模式下，组织新人只要熟悉特定代码仓库下的代码逻辑，在 monorepo 策略下，新人可能不得不花更多精力来理清各个代码仓库之间的相互逻辑，当然这个成本可以通过新人文档的方式来解决，但维护文档的新鲜又需要消耗额外的人力；
3. 对于公司级别的 monorepo 策略而已，需要专门的 VFS 系统，自动重构工具的支持：设想一下 Google 这样的企业是如何将十亿行的代码存储在一个仓库之中的？开发人员每次拉取代码需要等待多久？各个项目代码之间又如何实现权限管理，敏捷发布？任何简单的策略乘以足够的规模量级都会产生一个奇迹（不管是好是坏），对于中小企业而言，如果没有像 Google，Facebook 这样雄厚的人力资源，把所有项目代码放在同一个仓库里这个美好的愿望就只能是个空中楼阁。

## Monorepo 的坑洞

### 幽灵依赖

Q：npm/yarn 安装依赖时，存在依赖提升，某个项目使用的依赖，并没有在其 package.json 中声明，也可以直接使用，这种现象称之为 “幽灵依赖”；随着项目迭代，这个依赖不再被其他项目使用，不再被安装，使用幽灵依赖的项目，会因为无法找到依赖而报错。

A：基于 npm/yarn 的 Monorepo 方案，依然存在 “幽灵依赖” 问题，我们可以通过 pnpm 彻底解决这个问题

### 依赖安装时间长

Q：MonoRepo 中每个项目都有自己的 package.json 依赖列表，随着 MonoRepo 中依赖总数的增长，每次 install 时，耗时会较长。

A：相同版本依赖提升到 Monorepo 根目录下，减少冗余依赖安装；使用 pnpm 按需安装及依赖缓存。

### 构建打包时间长

Q：多个项目构建任务存在依赖时，往往是串行构建 或 全量构建，导致构建时间较长

A：增量构建，而非全量构建；也可以将串行构建，优化成并行构建。

## Monorepo 的技术选型

### Turborepo

### Nx

### Rush
